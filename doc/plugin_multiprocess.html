<html>
  <head>
    <title>nose: builtin plugin: multiprocess</title>
    <link rel="stylesheet" href="site.css" type="text/css"></link>
  </head>
  <body>
    
    <div id="menu">
      <p>This document covers nose version <b>0.11.0</b></p>
      <p>Last update: <b>Mon Sep  1 12:17:45 2008</b></p>
      <h2>Plugins</h2><ul><li><a href="plugin_attrib.html">Builtin Plugin: attrib</a></li><li><a href="plugin_capture.html">Builtin Plugin: capture</a></li><li><a href="plugin_cover.html">Builtin Plugin: cover</a></li><li><a href="plugin_debug.html">Builtin Plugin: debug</a></li><li><a href="plugin_deprecated.html">Builtin Plugin: deprecated</a></li><li><a href="plugin_doctests.html">Builtin Plugin: doctests</a></li><li><a href="plugin_failuredetail.html">Builtin Plugin: failuredetail</a></li><li><a href="plugin_isolate.html">Builtin Plugin: isolate</a></li><li><a href="plugin_logcapture.html">Builtin Plugin: logcapture</a></li><li><a href="plugin_multiprocess.html">Builtin Plugin: multiprocess</a></li><li><a href="plugin_prof.html">Builtin Plugin: prof</a></li><li><a href="plugin_skip.html">Builtin Plugin: skip</a></li><li><a href="plugin_testid.html">Builtin Plugin: testid</a></li><li><a href="error_class_plugin.html">ErrorClass Plugins</a></li><li><a href="plugin_interface.html">Plugin Interface</a></li><li><a href="writing_plugins.html">Writing Plugins</a></li></ul><h2>Modules</h2><ul><li><a href="module_nose.case.html">Module: nose.case</a></li><li><a href="module_nose.commands.html">Module: nose.commands</a></li><li><a href="module_nose.config.html">Module: nose.config</a></li><li><a href="module_nose.core.html">Module: nose.core</a></li><li><a href="module_nose.exc.html">Module: nose.exc</a></li><li><a href="module_nose.failure.html">Module: nose.failure</a></li><li><a href="module_nose.importer.html">Module: nose.importer</a></li><li><a href="module_nose.inspector.html">Module: nose.inspector</a></li><li><a href="module_nose.loader.html">Module: nose.loader</a></li><li><a href="module_nose.plugins.manager.html">Module: nose.plugins.manager</a></li><li><a href="module_nose.plugins.plugintest.html">Module: nose.plugins.plugintest</a></li><li><a href="module_nose.proxy.html">Module: nose.proxy</a></li><li><a href="module_nose.result.html">Module: nose.result</a></li><li><a href="module_nose.selector.html">Module: nose.selector</a></li><li><a href="module_nose.suite.html">Module: nose.suite</a></li><li><a href="module_nose.tools.html">Module: nose.tools</a></li><li><a href="module_nose.twistedtools.html">Module: nose.twistedtools</a></li><li><a href="module_nose.util.html">Module: nose.util</a></li></ul><h2>Plugin Examples</h2><ul><li><a href="doctest_fixtures.html">Doctest Fixtures</a></li><li><a href="unwanted_package.html">Excluding Unwanted Packages</a></li><li><a href="errorclass_failure.html">Failure of Errorclasses</a></li><li><a href="imported_tests.html">Importing Tests</a></li><li><a href="empty_plugin.html">Minimal plugin</a></li><li><a href="multiprocess.html">Parallel Testing with nose</a></li><li><a href="restricted_plugin_options.html">Restricted Plugin Managers</a></li><li><a href="init_plugin.html">Running Initialization Code Before the Test Run</a></li><li><a href="selector_plugin.html">Using a Custom Selector</a></li><li><a href="plugin_exceptions.html">When Plugins Fail</a></li><li><a href="plugintest_environment.html">nose.plugins.plugintest, os.environ and sys.argv</a></li></ul>
    </div>
    
    <div id="main">
      <h1>nose: builtin plugin: multiprocess</h1>
      
      <p>The multiprocess plugin enables you to distribute your test run among a set of
worker processes that run tests in parallel. This can speed up CPU-bound test
runs (as long as the number of work processeses is around the number of
processors or cores available), but is mainly useful for IO-bound tests which
can benefit from massive parallelization, since most of the tests spend most
of their time waiting for data to arrive from someplace else.</p>
<div class="section">
<h1><a id="how-tests-are-distributed" name="how-tests-are-distributed">How tests are distributed</a></h1>
<p>The ideal case would be to dispatch each test to a worker process
separately. This ideal is not attainable in all cases, however, because many
test suites depend on context (class, module or package) fixtures.</p>
<p>The plugin can't know (unless you tell it -- see below!) whether a given
context fixture is re-entrant (that is, can be called many times
concurrently), or may be shared among tests running in different
processes. Therefore, if a context has fixtures, the default behavior is to
dispatch the entire suite to a worker as a unit.</p>
<div class="section">
<h2><a id="controlling-distribution" name="controlling-distribution">Controlling distribution</a></h2>
<p>There are two context-level variables that you can use to control this default
behavior.</p>
<p>If a context's fixtures are re-entrant, set <cite>_multiprocess_can_split_ = True</cite>
in the context, and the plugin will dispatch tests in suites bound to that
context as if the context had no fixtures. This means that the fixtures will
execute multiple times, typically once per test, and concurrently.</p>
<p>If a context's fixtures may be shared by tests running in different processes
-- for instance a package-level fixture that starts an external http server or
initializes a shared database -- then set <cite>_multiprocess_shared_ = True</cite> in
the context. Fixtures for contexts so marked will execute in the primary nose
process, and tests in those contexts will be individually dispatched to run in
parallel.</p>
</div>
</div>
<div class="section">
<h1><a id="how-results-are-collected-and-reported" name="how-results-are-collected-and-reported">How results are collected and reported</a></h1>
<p>As each test or suite executes in a worker process, results (failures, errors,
and specially handled exceptions like SkipTest) are collected in that
process. When the test or suite is complete, the results are returned to the
main nose process. There, any progress output (dots) is printed, and the
results from the test or suite combined into a consolidated result
set. Finally when results have been received for all dispatched tests, or all
workers have died, the result summary is output as normal.</p>
</div>
<div class="section">
<h1><a id="beware" name="beware">Beware!</a></h1>
<p>Not all test suites will benefit from, or even operate correctly using, this
plugin. If you don't have multiple processors, CPU-bound tests will run more
slowly than otherwise, for instance. There are also some differences in plugin
interactions and behaviors due to the way in which tests are dispatched and
loaded. In general, test loading under the plugin operates as if it were
always in directed mode, not discovered mode. For instance, doctests in test
modules will always be found when using this plugin and the doctest plugin
together.</p>
<p>But most likely the biggest issue you will face is concurrency. Unless you
have kept your tests as religiously pure unit tests, with no side-effects, no
ordering issues, and no external dependencies, chances are you will experience
odd, intermittent and unexplainable failures and errors when using this
plugin. This doesn't necessarily mean the plugin is broken: it may mean that
your test suite is not safe for concurrency.</p>
</div>


      <h2>Plugin Methods Implemented</h2>

      <p>This plugin implements the following plugin interface methods:</p>
      
      <ul><li><a href="plugin_interface.html#configure">configure</a></li><li><a href="plugin_interface.html#options">options</a></li><li><a href="plugin_interface.html#prepareTestLoader">prepareTestLoader</a></li><li><a href="plugin_interface.html#prepareTestRunner">prepareTestRunner</a></li></ul>


      <h2>Commandline Options</h2>

      <p>This plugin adds the following commandline options:</p>

      <pre>Options:
  --processes=MULTIPROCESS_WORKERS
                        Spread test run among this many processes. Set a
                        number equal to the number of processors or cores in
                        your machine for best results. [NOSE_PROCESSES]
  --process-timeout=MULTIPROCESS_TIMEOUT
                        Set timeout for return of results from each test
                        runner process. [NOSE_PROCESS_TIMEOUT]
</pre>

      <h2>Source</h2>

      <div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Mutltiprocess: parallel testing</span>
<span class="sd">-------------------------------</span>

<span class="sd">The multiprocess plugin enables you to distribute your test run among a set of</span>
<span class="sd">worker processes that run tests in parallel. This can speed up CPU-bound test</span>
<span class="sd">runs (as long as the number of work processeses is around the number of</span>
<span class="sd">processors or cores available), but is mainly useful for IO-bound tests which</span>
<span class="sd">can benefit from massive parallelization, since most of the tests spend most</span>
<span class="sd">of their time waiting for data to arrive from someplace else.</span>

<span class="sd">How tests are distributed</span>
<span class="sd">=========================</span>

<span class="sd">The ideal case would be to dispatch each test to a worker process</span>
<span class="sd">separately. This ideal is not attainable in all cases, however, because many</span>
<span class="sd">test suites depend on context (class, module or package) fixtures.</span>

<span class="sd">The plugin can&#39;t know (unless you tell it -- see below!) whether a given</span>
<span class="sd">context fixture is re-entrant (that is, can be called many times</span>
<span class="sd">concurrently), or may be shared among tests running in different</span>
<span class="sd">processes. Therefore, if a context has fixtures, the default behavior is to</span>
<span class="sd">dispatch the entire suite to a worker as a unit.</span>

<span class="sd">Controlling distribution</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">There are two context-level variables that you can use to control this default</span>
<span class="sd">behavior.</span>

<span class="sd">If a context&#39;s fixtures are re-entrant, set `_multiprocess_can_split_ = True`</span>
<span class="sd">in the context, and the plugin will dispatch tests in suites bound to that</span>
<span class="sd">context as if the context had no fixtures. This means that the fixtures will</span>
<span class="sd">execute multiple times, typically once per test, and concurrently.</span>

<span class="sd">If a context&#39;s fixtures may be shared by tests running in different processes</span>
<span class="sd">-- for instance a package-level fixture that starts an external http server or</span>
<span class="sd">initializes a shared database -- then set `_multiprocess_shared_ = True` in</span>
<span class="sd">the context. Fixtures for contexts so marked will execute in the primary nose</span>
<span class="sd">process, and tests in those contexts will be individually dispatched to run in</span>
<span class="sd">parallel.</span>

<span class="sd">How results are collected and reported</span>
<span class="sd">======================================</span>

<span class="sd">As each test or suite executes in a worker process, results (failures, errors,</span>
<span class="sd">and specially handled exceptions like SkipTest) are collected in that</span>
<span class="sd">process. When the test or suite is complete, the results are returned to the</span>
<span class="sd">main nose process. There, any progress output (dots) is printed, and the</span>
<span class="sd">results from the test or suite combined into a consolidated result</span>
<span class="sd">set. Finally when results have been received for all dispatched tests, or all</span>
<span class="sd">workers have died, the result summary is output as normal.</span>

<span class="sd">Beware!</span>
<span class="sd">=======</span>

<span class="sd">Not all test suites will benefit from, or even operate correctly using, this</span>
<span class="sd">plugin. If you don&#39;t have multiple processors, CPU-bound tests will run more</span>
<span class="sd">slowly than otherwise, for instance. There are also some differences in plugin</span>
<span class="sd">interactions and behaviors due to the way in which tests are dispatched and</span>
<span class="sd">loaded. In general, test loading under the plugin operates as if it were</span>
<span class="sd">always in directed mode, not discovered mode. For instance, doctests in test</span>
<span class="sd">modules will always be found when using this plugin and the doctest plugin</span>
<span class="sd">together.</span>

<span class="sd">But most likely the biggest issue you will face is concurrency. Unless you</span>
<span class="sd">have kept your tests as religiously pure unit tests, with no side-effects, no</span>
<span class="sd">ordering issues, and no external dependencies, chances are you will experience</span>
<span class="sd">odd, intermittent and unexplainable failures and errors when using this</span>
<span class="sd">plugin. This doesn&#39;t necessarily mean the plugin is broken: it may mean that</span>
<span class="sd">your test suite is not safe for concurrency.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="k">import</span> <span class="nn">logging</span>
<span class="k">import</span> <span class="nn">os</span>
<span class="k">import</span> <span class="nn">sys</span>
<span class="k">import</span> <span class="nn">time</span>
<span class="k">import</span> <span class="nn">traceback</span>
<span class="k">import</span> <span class="nn">unittest</span>
<span class="k">import</span> <span class="nn">nose.case</span>
<span class="k">from</span> <span class="nn">nose.core</span> <span class="k">import</span> <span class="n">TextTestRunner</span>
<span class="k">from</span> <span class="nn">nose</span> <span class="k">import</span> <span class="n">failure</span>
<span class="k">from</span> <span class="nn">nose</span> <span class="k">import</span> <span class="n">loader</span>
<span class="k">from</span> <span class="nn">nose.plugins.base</span> <span class="k">import</span> <span class="n">Plugin</span>
<span class="k">from</span> <span class="nn">nose.result</span> <span class="k">import</span> <span class="n">TextTestResult</span>
<span class="k">from</span> <span class="nn">nose.suite</span> <span class="k">import</span> <span class="n">ContextSuite</span>
<span class="k">from</span> <span class="nn">nose.util</span> <span class="k">import</span> <span class="n">test_address</span>
<span class="k">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Empty</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="c"># debugging repeat log messages</span>
<span class="c">#class FakeLog:</span>
<span class="c">#    def __init__(self, out=sys.stderr):</span>
<span class="c">#        self.out = out</span>
<span class="c">#    def debug(self, msg, *arg):</span>
<span class="c">#        print &gt;&gt; self.out, &quot;!&quot;, msg % arg</span>
<span class="c">#log = FakeLog()</span>
        
<span class="k">try</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">processing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Event</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Process</span> <span class="o">=</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Pool</span> <span class="o">=</span> <span class="n">Event</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;processing module not available&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">import</span> <span class="nn">StringIO</span>


<span class="k">class</span> <span class="nc">TestLet</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_short_description</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">shortDescription</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="k">def</span> <span class="nf">shortDescription</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_short_description</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str</span>


<span class="k">class</span> <span class="nc">MultiProcess</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run tests in multiple processes. Requires processing module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1000</span>

    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can_configure</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--processes&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;NOSE_PROCESSES&#39;</span><span class="p">,</span> <span class="mf">0</span><span class="p">),</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s">&quot;multiprocess_workers&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s">&quot;Spread test run among this many processes. &quot;</span>
                          <span class="s">&quot;Set a number equal to the number of processors &quot;</span>
                          <span class="s">&quot;or cores in your machine for best results. &quot;</span>
                          <span class="s">&quot;[NOSE_PROCESSES]&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--process-timeout&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;NOSE_PROCESS_TIMEOUT&#39;</span><span class="p">,</span> <span class="mf">10</span><span class="p">),</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s">&quot;multiprocess_timeout&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s">&quot;Set timeout for return of results from each &quot;</span>
                          <span class="s">&quot;test runner process. [NOSE_PROCESS_TIMEOUT]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&#39;multiprocess_workers&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">multiprocess_workers</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">workers</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">if</span> <span class="n">workers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_workers</span> <span class="o">=</span> <span class="n">workers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">multiprocess_timeout</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">prepareTestLoader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaderClass</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">__class__</span>
        
    <span class="k">def</span> <span class="nf">prepareTestRunner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">):</span>
        <span class="c"># replace with our runner class</span>
        <span class="k">return</span> <span class="n">MultiProcessTestRunner</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span>
                                      <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                                      <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                      <span class="n">loaderClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loaderClass</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MultiProcessTestRunner</span><span class="p">(</span><span class="n">TextTestRunner</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaderClass</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;loaderClass&#39;</span><span class="p">,</span> <span class="n">loader</span><span class="o">.</span><span class="n">defaultTestLoader</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiProcessTestRunner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the test (which may be a test suite). If the test is a suite,</span>
<span class="sd">        distribute it out among as many processes as have been configured, at</span>
<span class="sd">        as fine a level as is possible given the context fixtures defined in the</span>
<span class="sd">        suite or any sub-suites.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">prepareTest</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">wrapper</span>
        
        <span class="c"># plugins can decorate or capture the output stream</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">setOutputStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrapped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">wrapped</span>

        <span class="n">testQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">resultQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">to_teardown</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shouldStop</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeResult</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c"># dispatch and collect results</span>
        <span class="c"># put indexes only on queue because tests aren&#39;t picklable</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_batch</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Next batch </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">nose</span><span class="o">.</span><span class="n">case</span><span class="o">.</span><span class="n">Test</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">)):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Case is a Failure&quot;</span><span class="p">)</span>
                <span class="n">case</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="c"># run here to capture the failure</span>
                <span class="k">continue</span>
            <span class="c"># handle shared fixtures</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">ContextSuite</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharedFixtures</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> has shared fixtures&quot;</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">case</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> setup failed&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_teardown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_t</span> <span class="ow">in</span> <span class="n">case</span><span class="p">:</span>
                        <span class="n">test_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">(</span><span class="n">_t</span><span class="p">)</span>
                        <span class="n">testQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">test_addr</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="n">tasks</span><span class="p">[</span><span class="n">test_addr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Queued shared-fixture test </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) to </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">testQueue</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
                <span class="n">testQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">test_addr</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">tasks</span><span class="p">[</span><span class="n">test_addr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Queued test </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) to </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">testQueue</span><span class="p">)</span>
            
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting </span><span class="si">%s</span><span class="s"> workers&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_workers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_workers</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
                                             <span class="n">testQueue</span><span class="p">,</span>
                                             <span class="n">resultQueue</span><span class="p">,</span>
                                             <span class="n">shouldStop</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">loaderClass</span><span class="p">,</span>
                                             <span class="n">result</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Started worker process </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span>

        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>            
        <span class="k">while</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Waiting for results (</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s"> tasks)&quot;</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">),</span> <span class="n">num_tasks</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">addr</span><span class="p">,</span> <span class="n">batch_result</span> <span class="o">=</span> <span class="n">resultQueue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_timeout</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Results received for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Got result for unknown task? </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">completed</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consolidate</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">batch_result</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stopOnError</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">()):</span>
                    <span class="c"># set the stop condition</span>
                    <span class="n">shouldStop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Timed out with </span><span class="si">%s</span><span class="s"> tasks pending&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
                <span class="n">any_alive</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                        <span class="n">any_alive</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">any_alive</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;All workers dead&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Completed </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s"> tasks (</span><span class="si">%s</span><span class="s"> remain)&quot;</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">),</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">to_teardown</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Tearing down shared fixtures for </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">case</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        
        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">result</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">printSummary</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c"># Tell all workers to stop</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="n">testQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;STOP&#39;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="s">&#39;address&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">file</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">call</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">address</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">import</span> <span class="nn">sys</span>
                <span class="k">import</span> <span class="nn">pdb</span>
                <span class="n">ec</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="s">&#39;context&#39;</span><span class="p">):</span>
            <span class="nb">file</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">call</span> <span class="o">=</span> <span class="n">test_address</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unable to convert </span><span class="si">%s</span><span class="s"> to address&quot;</span> <span class="o">%</span> <span class="n">case</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unaddressable case </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">case</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">parts</span><span class="p">))</span>

    <span class="c"># FIXME camel for consistency</span>
    <span class="k">def</span> <span class="nf">next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="c"># allows tests or suites to mark themselves as not safe</span>
        <span class="c"># for multiprocess execution</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">&#39;context&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_multiprocess_&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ContextSuite</span><span class="p">)</span>
             <span class="ow">and</span> <span class="n">test</span><span class="o">.</span><span class="n">hasFixtures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_can_split</span><span class="p">))</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">&#39;can_split&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">)):</span>
            <span class="c"># regular test case, or a suite with context fixtures</span>
            <span class="c"># either way we&#39;ve hit something we can ask a worker</span>
            <span class="c"># to run</span>
            <span class="k">yield</span> <span class="n">test</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Suite is without fixtures at this level; but it may have</span>
            <span class="c"># fixtures at any deeper level, so we need to examine it all</span>
            <span class="c"># the way down to the case level</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_batch</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">batch</span>

    <span class="c"># FIXME camel for consistency</span>
    <span class="k">def</span> <span class="nf">check_can_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fixt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback that we use to check whether the fixtures found in a</span>
<span class="sd">        context or ancestor are ones we care about.</span>

<span class="sd">        Contexts can tell us that their fixtures are reentrant by setting</span>
<span class="sd">        _multiprocess_can_split_. So if we see that, we return False to</span>
<span class="sd">        disregard those fixtures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_multiprocess_can_split_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">sharedFixtures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="s">&#39;context&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_multiprocess_shared_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>            

    <span class="k">def</span> <span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">batch_result</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;batch result is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="p">,</span> <span class="n">batch_result</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">testsRun</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errorClasses</span> <span class="o">=</span> <span class="n">batch_result</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;result in unexpected format </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">batch_result</span><span class="p">)</span>
            <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">testsRun</span> <span class="o">+=</span> <span class="n">testsRun</span>
        <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">isfail</span><span class="p">)</span> <span class="ow">in</span> <span class="n">errorClasses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errorClasses</span><span class="p">:</span>
                <span class="c"># Ordinarily storage is result attribute</span>
                <span class="c"># but it&#39;s only processed through the errorClasses</span>
                <span class="c"># dict, so it&#39;s ok to fake it here</span>
                <span class="n">result</span><span class="o">.</span><span class="n">errorClasses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">([],</span> <span class="n">label</span><span class="p">,</span> <span class="n">isfail</span><span class="p">)</span>
            <span class="n">mystorage</span><span class="p">,</span> <span class="n">_junk</span><span class="p">,</span> <span class="n">_junk</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">errorClasses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">mystorage</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Ran </span><span class="si">%s</span><span class="s"> tests (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="n">testsRun</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">testsRun</span><span class="p">)</span>

            
<span class="k">def</span> <span class="nf">runner</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">testQueue</span><span class="p">,</span> <span class="n">resultQueue</span><span class="p">,</span> <span class="n">shouldStop</span><span class="p">,</span>
           <span class="n">loaderClass</span><span class="p">,</span> <span class="n">resultClass</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Worker </span><span class="si">%s</span><span class="s"> executing&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">loaderClass</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">loader</span><span class="o">.</span><span class="n">suiteClass</span><span class="o">.</span><span class="n">suiteClass</span> <span class="o">=</span> <span class="n">NoSharedFixtureContextSuite</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">testQueue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">multiprocess_timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">case</span>
            
    <span class="k">def</span> <span class="nf">makeResult</span><span class="p">():</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">_WritelnDecorator</span><span class="p">(</span><span class="n">StringIO</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">resultClass</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">descriptions</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span>
                           <span class="n">verbosity</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                           <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TestLet</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TestLet</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">]</span>
        <span class="n">errorClasses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">isfail</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errorClasses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">errorClasses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">([(</span><span class="n">TestLet</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">storage</span><span class="p">],</span>
                                 <span class="n">label</span><span class="p">,</span> <span class="n">isfail</span><span class="p">)</span>                
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
            <span class="n">result</span><span class="o">.</span><span class="n">testsRun</span><span class="p">,</span>
            <span class="n">failures</span><span class="p">,</span>
            <span class="n">errors</span><span class="p">,</span>
            <span class="n">errorClasses</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test_addr</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">get</span><span class="p">,</span> <span class="s">&#39;STOP&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">shouldStop</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">makeResult</span><span class="p">()</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadTestsFromNames</span><span class="p">([</span><span class="n">test_addr</span><span class="p">])</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Worker </span><span class="si">%s</span><span class="s"> Test is </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">test_addr</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">resultQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">test_addr</span><span class="p">,</span> <span class="n">batch</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Error running test or returning results&quot;</span><span class="p">)</span>
                    <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">resultQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">test_addr</span><span class="p">,</span> <span class="n">batch</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Worker </span><span class="si">%s</span><span class="s"> timed out waiting for tasks&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">resultQueue</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Worker </span><span class="si">%s</span><span class="s"> ending&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoSharedFixtureContextSuite</span><span class="p">(</span><span class="n">ContextSuite</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context suite that never fires shared fixtures.</span>

<span class="sd">    When a context sets _multiprocess_shared_, fixtures in that context</span>
<span class="sd">    are executed by the main process. Using this suite class prevents them</span>
<span class="sd">    from executing in the runner process as well.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">setupContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_multiprocess_shared_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NoSharedFixtureContextSuite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setupContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardownContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_multiprocess_shared_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NoSharedFixtureContextSuite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">teardownContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>


    </div>
    <script src="http://www.google-analytics.com/urchin.js" 
	    type="text/javascript">
    </script>
    <script type="text/javascript">
      _uacct = "UA-2236166-1";
      urchinTracker();
    </script>
  </body>
</html>
  
